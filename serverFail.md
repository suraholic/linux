
서버 장애 원인 파악
=================

## 1. CPU 상태 확인 
서버 퍼포먼스 문제가 있다면 top 명령어로 CPU 사용량을 확인한다. 당신이 만든 어플리케이션이 지나치게 많은 CPU를 (50% 이상) 먹고있지 않은지 확인한다. 

> top

## 2. 메모리 상태 확인 
아래 명령어로 얼마나 메모리가 남았나 확인한다. 최소한 500메가 이상은 남아줘야 커널패닉이 나지 않는다. 

> free -m 

## 3. 프로세스 (쓰레드 상태) 확인 
프로세스가 너무 많이 생겼거나 아예 프로세스가 죽어버린 경우가 있다. 본인이 띄운 프로세스가 살아 있는지 확인한다. 

> ps -ef | grep < process name >  

## 4. 서비스 / 데몬 확인 
데몬(daemon)은 백그라운드에서 돌아가는 프로세스를 말한다. 윈도우즈의 서비스를 생각하면 된다. 본인의 서버 프로그램이 데몬으로 돌아간다면 프로세스가 잘 돌아가고 있는지 확인한다.  

> service < daemon name > status 

## 5. 네트워크 상태 확인  
현재 서버의 네트워크 설정 및 상태를 보고 싶다면 아래 명령어를 쓴다.  

> ifconfig 

## 6. 내 서버에서 접속이 가능한가??  
TCP 80, 443등의 특수 포트가 열려 있는지 확인하고자 한다면  

> nc < hostname > < port > 

> nc localhost 80 

> nc localhost 443  

UDP인 경우 u 옵션으로 빠르게 확인해 볼 수 있다. 
> nc -u < hostnmae > < port > 

hostname을 외부 서버로 해두면 이 서버에서 해당 host로 접속이 가능한지 확인해 볼 수 있다. 
예를 들어, 방화벽으로 막혀 있는가 등을 확인해 볼수 있다. 좀더 자세한 output을 위해선 -v 옵션을, 연결테스트 하는데 3초만 기다리고 싶다면 -w3 옵션을 주자. 

## 7. 사용중인 port 확인  
> lsof -i TCP:80 

특정 프로세스가 어떤 포트를 사용하고 있는지 확인 
> lsof -c httpd 

## 8. 네트워크 연결 수 확인  
서버의 응답이 늦어질때 요청이 서버에 엄청 몰리는게 문제인지 알고 싶을때가 있다. 이때엔 네트워크 연결수로 확인해볼수 있다. 
> netstat -nap | grep ESTAB | wc  

연결수가 지나치게 많다면 어디선가 자꾸 연결이 생성되고 있다고 보면된다. 요청이 외부에서 들어온다면 몰리는 것이고 아니라면 뭔가 서버에 이상이 있는 것이다. 

> netstat -nap | grep TIME_WAIT | wc  

TIME_WAIT 수가 비정상적으로 많으면 들어오는 요청을 서버에서 제대로 처리를 못하고 있다고 보면된다. 한마디로 병목현상이 벌어지고 있는 것이다.  

## 9. 디스크 상태 확인  
디스크 볼륨별로 얼마나 차 있는지, 빈 공간이 얼마나 남았는지 알고 싶다면 다음명령어로 확인한다.  

> df -uh  
root와 swap 볼륨이 충분한 여유가 있어야 한다.  

## 10. 로킹 상태 확인  
 리눅스의 서버 로그는 /var/log 폴더 아래 저장이 되는데 여기에 본인 어플리케이션의 로그를 log rotation 시켜놓지 않는 경우가 있다.

그래서 단일 로그파일이 수 기가 바이트를 우습게 넘기는걸 종종 목격하는데 파일이 크면 클수록 프로세스가 처리하기 힘들어지고 결국 성능 저하로 연결된다. 메모리가 점점 늘어나고, 디스크 읽기 쓰기 성능이 계속 저하되는 증상을 보이지만 모니터링을 하지 않기 때문에 모르는 경우도 많고 이게 문제인지도 몰라서 고생하는걸 여러번 봤다.

log rotate를 처음 들어보고, 본인 서버 어플리케이션 성능이 계속 저하된다면 본인 서버의 로그가 어디 찍히는지 확인해보자.


<hr>

* 발췌 (출처) : <https://medium.com/hbsmith/linux-%EC%84%9C%EB%B2%84-%EC%9E%A5%EC%95%A0%EC%9B%90%EC%9D%B8-%ED%8C%8C%EC%95%85%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-7accec423bb5>


